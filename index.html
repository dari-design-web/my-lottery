<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 å¹´çµ‚æŠ½çç³»çµ± V3.1</title>
    <style>
        :root { 
            --gold: #ffd700; 
            --red: #b22222; 
            --bright-red: #d32f2f;
            --dark-gold: #c5a500; 
            --btn-glow: rgba(255, 215, 0, 0.6); 
            --light-gray: #e5e5e5;
        }
        
        * { box-sizing: border-box; }
        
        html, body, a, button, .card, canvas { cursor: pointer !important; }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: #000; font-family: "Microsoft JhengHei", sans-serif; 
            color: white; overflow: hidden; 
        }

        /* é»æ“Šé‡‘è‰²å…‰æšˆ */
        .click-halo {
            position: fixed; width: 10px; height: 10px;
            background: rgba(255, 215, 0, 0.5); border: 2px solid var(--gold);
            border-radius: 50%; pointer-events: none; z-index: 100000;
            transform: translate(-50%, -50%);
            animation: halo-effect 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            box-shadow: 0 0 20px var(--gold);
        }
        @keyframes halo-effect {
            0% { width: 10px; height: 10px; opacity: 1; }
            100% { width: 120px; height: 120px; opacity: 0; }
        }

        .page { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            display: none; z-index: 1;
            background: url('bg1.jpg') no-repeat center center;
            background-size: cover;
        }

        .glass-overlay {
            position: absolute; inset: 0;
            background: rgba(0,0,0,0.6);
            display: flex; flex-direction: column; align-items: center; padding-top: 5vh;
            overflow-y: auto; 
            padding-bottom: 180px; 
        }

        h1 { font-size: 6vh; color: var(--gold); text-shadow: 2px 2px 15px #000; margin-bottom: 3vh; text-align: center; }

        .home-menu { display: flex; gap: 30px; margin-top: 10vh; }
        .menu-btn {
            padding: 30px 60px; font-size: 4vh; font-weight: bold;
            background: linear-gradient(135deg, #800 0%, #400 100%);
            border: 3px solid var(--gold); border-radius: 20px;
            color: var(--gold); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: 0.3s;
        }
        .menu-btn:hover { transform: scale(1.1); background: #a00; box-shadow: 0 0 30px var(--gold); }

        /* è¨­å®šä»‹é¢ */
        .settings-container {
            width: 95%; max-width: 1300px; background: rgba(0,0,0,0.85);
            padding: 30px; border-radius: 20px; border: 1px solid var(--gold);
            margin-bottom: 50px;
        }
        .settings-row { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; }
        .settings-row input { 
            padding: 10px; border-radius: 5px; border: 1px solid #555; 
            background: #fff; color: #000; font-size: 14px; font-weight: bold;
        }
        .row-name { flex: 0.8; }
        .row-content { flex: 2; }
        .row-img { flex: 1.2; }
        .row-count { flex: 0.5; }
        .btn-del { background: #f44; border: none; color: white; padding: 10px 15px; border-radius: 5px; }
        .btn-add { background: #28a745; border: none; color: white; padding: 10px 20px; border-radius: 5px; margin-bottom: 20px; font-size: 18px; }
        
        .settings-actions { display: flex; gap: 15px; justify-content: center; margin-top: 30px; }
        .btn-save { background: var(--gold); border: none; color: black; padding: 15px 60px; border-radius: 50px; font-weight: bold; font-size: 24px; box-shadow: 0 0 20px rgba(255, 215, 0, 0.4); transition: 0.3s; }

        /* çé …é¸æ“‡å¡ç‰‡å€ */
        .prize-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; width: 95%; max-width: 1500px; }
        .card { 
            position: relative;
            background: rgba(0,0,0,0.85); border: 2px solid var(--gold); 
            border-radius: 20px; padding: 15px; text-align: center;
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column; align-items: center;
            min-height: 420px;
            overflow: hidden;
        }
        .card:hover { transform: translateY(-10px); background: rgba(139,0,0,0.9); box-shadow: 0 0 25px var(--gold); }
        
        /* ç´…åŒ…é®ç½© */
        .prize-overlay {
            position: absolute; inset: 0;
            background: linear-gradient(135deg, #b22222 0%, #800000 100%);
            z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 1.5s ease-in-out, visibility 1.5s;
        }
        .prize-overlay.unlocked { opacity: 0; pointer-events: none; visibility: hidden; }

        /* é–‹å•Ÿçé …æŒ‰éˆ• */
        .unlock-btn {
            background: var(--gold); color: #000; border: none; padding: 12px 30px; font-size: 22px; font-weight: bold; border-radius: 50px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: 0.3s;
        }
        .unlock-btn:hover { animation: bounce-shine 0.8s infinite; }
        @keyframes bounce-shine {
            0%, 100% { transform: scale(1); box-shadow: 0 0 10px var(--gold); }
            50% { transform: scale(1.1); box-shadow: 0 0 30px var(--gold); background: #fff; }
        }

        /* åœ–ç‰‡ç¸®æ”¾å‹•ç•«å®¹å™¨ */
        .card-img-wrapper {
            width: 100%; height: 180px;
            border-radius: 10px; background: var(--light-gray); 
            overflow: hidden; margin-bottom: 12px;
            border: 1px solid rgba(255,215,0,0.4);
            display: flex; align-items: center; justify-content: center;
        }
        .card-img { 
            width: 100%; height: 100%; object-fit: contain; 
            transform: scale(2.2); 
            transition: transform 1.5s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .card:hover .card-img { transform: scale(1.0); }
        
        .winner-tag-container { margin-top: auto; width: 100%; display: flex; flex-direction: column; align-items: center; padding-top: 10px; }
        .winner-label { color: #00ff00; font-size: 1.6vh; font-weight: bold; margin-bottom: 6px; }
        .winner-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 4px; width: 100%; }
        .winner-num { background: rgba(0, 255, 0, 0.2); border: 1px solid #00ff00; color: #00ff00; padding: 2px 6px; border-radius: 4px; font-size: 1.4vh; font-weight: bold; }

        /* æŠ½çä¸»æ¡† */
        .display-frame {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            width: 84vw; height: 62vh; background: rgba(255, 255, 255, 0.95);
            border: 10px solid var(--gold); border-radius: 30px;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.1), 0 0 30px var(--dark-gold);
            overflow: hidden; backdrop-filter: blur(8px);
            display: flex;
            z-index: 10;
        }
        .draw-left-img-box { 
            flex: 1; border-right: 2.5px dashed var(--gold); 
            display: flex; align-items: center; justify-content: center; 
            padding: 30px; background: var(--light-gray); overflow: hidden;
        }
        .draw-right-nums-box { flex: 1.5; position: relative; display: flex; align-items: center; justify-content: center; }
        
        .prize-main-img { 
            max-width: 95%; max-height: 95%; border-radius: 15px; 
            object-fit: contain; 
            animation: prize-reveal 1.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        @keyframes prize-reveal { from { transform: scale(2.0); } to { transform: scale(1.0); } }

        /* åº•éƒ¨åŠŸèƒ½åˆ— */
        .bottom-actions {
            position: fixed; bottom: 0; left: 0; width: 100%;
            padding: 30px 0; display: flex; gap: 25px; justify-content: center;
            z-index: 2000; background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px); border-top: 2.5px solid var(--gold);
            box-shadow: 0 -15px 50px rgba(0,0,0,1);
        }
        .action-btn { 
            padding: 14px 40px; border-radius: 50px; border: 2.5px solid var(--gold); 
            background: rgba(0,0,0,0.5); color: var(--gold); font-weight: bold; font-size: 20px;
            transition: 0.3s;
        }
        .action-btn:hover { background: var(--gold); color: black; transform: translateY(-5px); }
        .action-btn.danger { border-color: #ff4444; color: #ff4444; }
        .btn-back-home { border-color: #fff; color: #fff; background: rgba(255,255,255,0.1); }

        #slot-canvas { width: 100%; height: 100%; position: relative; z-index: 20; }
        
        /* ç…™ç« Canvas */
        #fw-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 30; /* åœ¨æ‰€æœ‰å…ƒä»¶ä¹‹ä¸Š */
        }
    </style>
</head>
<body>

<canvas id="fw-canvas"></canvas>

<div id="home-page" class="page" style="display: block;">
    <div class="glass-overlay">
        <h1>2025 å¹´çµ‚æŠ½ç V3.1</h1>
        <div class="home-menu">
            <button class="menu-btn" onclick="showPage('settings-page')">âš™ï¸ çé …è¨­å®š</button>
            <button class="menu-btn" onclick="showPage('prize-list-page')">ğŸ° é–‹å§‹æŠ½ç</button>
        </div>
    </div>
</div>

<div id="settings-page" class="page">
    <div class="glass-overlay">
        <h1>çé …è¨­å®šç³»çµ±</h1>
        <div class="settings-container">
            <div style="margin-bottom: 25px; font-size: 22px; color: white;">
                ğŸ‘¥ åƒèˆ‡æŠ½çç¸½äººæ•¸ï¼š
                <input type="number" id="total-participants" style="width: 120px; color: black; background: white; border: none; border-radius: 5px; padding: 5px;" value="50"> äºº
            </div>
            <div id="settings-list"></div>
            <button class="btn-add" onclick="addPrizeRow()">ï¼‹ æ–°å¢çé …</button>
            <div class="settings-actions">
                <button class="btn-save" onclick="saveSettings()">ç¢ºå®šä¸¦è¿”å›</button>
            </div>
        </div>
    </div>
</div>

<div id="prize-list-page" class="page">
    <div class="glass-overlay">
        <h1>è«‹æ­æ›‰ä¸¦é¸æ“‡çé …</h1>
        <div class="prize-grid" id="main-prize-grid"></div>
        <div class="bottom-actions">
            <button class="action-btn danger" onclick="resetAllWinners()">ğŸ”„ é‡æ–°æŠ½ç</button>
            <button class="action-btn" onclick="exportWinnersToCSV()">ğŸ“Š å„²å­˜å¾—çè€…</button>
            <button class="action-btn btn-back-home" onclick="showPage('home-page')">è¿”å›é¦–é </button>
        </div>
    </div>
</div>

<div id="draw-page" class="page">
    <div class="display-frame">
        <div class="draw-left-img-box">
            <img id="prize-main-img" src="" class="prize-main-img" onerror="this.src='https://placehold.co/600x600?text=ç…§ç‰‡æª”æ¡ˆç¼ºå¤±'">
        </div>
        <div class="draw-right-nums-box">
            <canvas id="slot-canvas"></canvas>
        </div>
    </div>
    <div style="position: absolute; bottom: 10vh; left: 50%; transform: translateX(-50%); z-index: 100;">
        <button id="main-draw-btn" style="padding: 18px 100px; font-size: 4vh; font-weight: bold; color: #000; background: linear-gradient(135deg, var(--gold) 0%, #fff 50%, var(--gold) 100%); background-size: 200% 200%; border: none; border-radius: 60px; box-shadow: 0 0 25px var(--btn-glow); animation: shine-bg 3s infinite linear; cursor:pointer;" onclick="handleDrawStart()">é–‹å§‹æŠ½ç</button>
    </div>
    <button class="action-btn" style="position: fixed; bottom: 3vh; right: 3vh; z-index: 2001;" onclick="showPage('prize-list-page')">è¿”å›åˆ—è¡¨</button>
</div>

<script>
    const STORAGE_KEY = 'v2_lottery_v31_firework_edition';

    // çé …æ¸…å–®ç²¾æº–æ›´æ–°
    const INITIAL_DATA = {
        totalParticipants: 50,
        prizes: [
            { name: "1 ç", item: "Xiaomi æ™ºæ…§é¡¯ç¤ºå™¨ A Pro 2026 75å‹ QLED", count: 1, winners: [], img: "01.jpg", unlocked: false },
            { name: "2 ç", item: "Xiaomi æƒæ‹–æ©Ÿå™¨äºº 5 Pro", count: 1, winners: [], img: "02.jpg", unlocked: false },
            { name: "3 ç", item: "SWITCH 2 ä¸»æ©Ÿ", count: 1, winners: [], img: "03.jpg", unlocked: false },
            { name: "4 ç", item: "Apple å¹³æ¿ iPad 11 A16 Wi-Fi (128G)", count: 1, winners: [], img: "04.jpg", unlocked: false },
            { name: "5 ç", item: "é£›åˆ©æµ¦æŠ—æ•å¥ˆç±³ç´šç©ºæ°£æ¸…æ·¨æ©Ÿ", count: 1, winners: [], img: "05.jpg", unlocked: false },
            { name: "6 ç", item: "Apple Watch SE 3ä»£ (44mm) GPSç‰ˆ", count: 1, winners: [], img: "06.jpg", unlocked: false },
            { name: "7 ç", item: "Panasonic é«˜æ»²é€å¥ˆç±³æ°´é›¢å­å¹é¢¨æ©ŸNavy", count: 1, winners: [], img: "07.jpg", unlocked: false },
            { name: "8 ç", item: "SWITCH 1 ä¸»æ©Ÿ(ç¾æœ‰)", count: 2, winners: [], img: "08.jpg", unlocked: false },
            { name: "9 ç", item: "Panasonic 8å…¬å‡ä¸€ç´šèƒ½æ•ˆæ¸…æ·¨é™¤æ¿•æ©Ÿ", count: 1, winners: [], img: "09.jpg", unlocked: false },
            { name: "10 ç", item: "PHILIPS æ˜Ÿè¦–ç•Œé€è¦–æµ·æ˜Ÿæ°£ç‚¸é‹4.2L", count: 1, winners: [], img: "10.jpg", unlocked: false },
            { name: "11 ç", item: "AirPods 4ä»£ (ä¸»å‹•é™å™ªç‰ˆ)", count: 2, winners: [], img: "11.jpg", unlocked: false },
            { name: "12 ç", item: "OSIMè­·çœ¼æ¨‚Air 2", count: 2, winners: [], img: "12.jpg", unlocked: false },
            { name: "13 ç", item: "æ—¥æœ¬BRUNO å¤šåŠŸèƒ½é›»çƒ¤ç›¤BOE021", count: 2, winners: [], img: "13.jpg", unlocked: false },
            { name: "14 ç", item: "ç¾é‡‘ 2000", count: 8, winners: [], img: "14.jpg", unlocked: false },
            { name: "15 ç", item: "ç¾é‡‘ 1000", count: 9, winners: [], img: "15.jpg", unlocked: false },
            { name: "16 ç", item: "ç¾é‡‘ 600", count: 10, winners: [], img: "16.jpg", unlocked: false }
        ]
    };

    let lotteryConfig = { ...INITIAL_DATA };
    let drawnNumbers = new Set();
    let currentPrizeIdx = null;
    let rolling = false;
    let timer = null;
    let currentDisplayNums = [];
    let finalizedCount = 0;
    let targetResults = [];
    let numberScales = [];
    let flashIntensity = [];
    const canvas = document.getElementById('slot-canvas');
    const ctx = canvas.getContext('2d');

    // ç…™ç«å°ˆç”¨è®Šæ•¸
    const fwCanvas = document.getElementById('fw-canvas');
    const fwCtx = fwCanvas.getContext('2d');
    let particles = [];
    let fwAnimationId = null;

    function initSystem() {
        const localData = localStorage.getItem(STORAGE_KEY);
        if (localData) { lotteryConfig = JSON.parse(localData); } else { saveState(); }
        updateDrawnSet(); renderPrizeList(); renderSettings();
        window.addEventListener('resize', resizeFwCanvas);
        resizeFwCanvas();
    }

    function updateDrawnSet() {
        drawnNumbers.clear();
        lotteryConfig.prizes.forEach(p => { if(p.winners) p.winners.forEach(w => drawnNumbers.add(w)); });
    }

    function saveState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(lotteryConfig));
        updateDrawnSet();
    }

    function unlockPrize(idx, event) {
        event.stopPropagation();
        document.getElementById(`overlay-${idx}`).classList.add('unlocked');
        lotteryConfig.prizes[idx].unlocked = true;
        saveState();
    }

    function resetAllWinners() {
        if (confirm("âš ï¸ æ³¨æ„ï¼šåå–®ä¸€æ—¦æ¸…ç©ºå°‡é‡æ–°é–å®šæ‰€æœ‰çé …ä¸¦é—œé–‰ç…™ç«ï¼ç¢ºå®šå—ï¼Ÿ")) {
            lotteryConfig.prizes.forEach(p => { p.winners = []; p.unlocked = false; });
            drawnNumbers.clear(); particles = [];
            saveState(); renderPrizeList();
            alert("ç³»çµ±å·²é‡ç½®ã€‚");
        }
    }

    function exportWinnersToCSV() {
        let csvContent = "\uFEFF"; 
        let maxCount = 0;
        lotteryConfig.prizes.forEach(p => { if(p.count > maxCount) maxCount = p.count; });
        let header = ["çé …åºè™Ÿ", "å“é …åç¨±", "ç¸½åé¡"];
        for(let i=1; i<=maxCount; i++) header.push(`ä¸­çè€…${i}`);
        csvContent += header.join(",") + "\n";
        lotteryConfig.prizes.forEach(p => {
            let row = [p.name, p.item, p.count];
            const sorted = p.winners ? [...p.winners].sort((a,b)=>a-b) : [];
            for(let i=0; i<maxCount; i++) row.push(sorted[i] || ""); 
            csvContent += row.join(",") + "\n";
        });
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url); link.setAttribute("download", `2025å¹´çµ‚æŠ½ççµæœ.csv`);
        link.click();
    }

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        if (id === 'draw-page') {
            particles = []; // é€²å…¥æ–°æŠ½çé å…ˆæ¸…ç©ºç…™ç«
            const imgEl = document.getElementById('prize-main-img');
            imgEl.src = lotteryConfig.prizes[currentPrizeIdx].img || '';
            imgEl.style.animation = 'none'; imgEl.offsetHeight; imgEl.style.animation = null;
            setTimeout(syncCanvas, 100);
        }
        if (id === 'prize-list-page') { cancelAnimationFrame(fwAnimationId); renderPrizeList(); }
        if (id === 'settings-page') renderSettings();
    }

    // --- ç…™ç«ç³»çµ±æ ¸å¿ƒ ---
    function resizeFwCanvas() {
        fwCanvas.width = window.innerWidth;
        fwCanvas.height = window.innerHeight;
    }

    class Particle {
        constructor(x, y, color, velocity) {
            this.x = x; this.y = y; this.color = color; this.velocity = velocity;
            this.alpha = 1; this.friction = 0.95; this.gravity = 0.15;
        }
        draw() {
            fwCtx.save();
            fwCtx.globalAlpha = this.alpha;
            fwCtx.beginPath();
            fwCtx.arc(this.x, this.y, 2, 0, Math.PI * 2);
            fwCtx.fillStyle = this.color;
            fwCtx.fill();
            fwCtx.restore();
        }
        update() {
            this.velocity.x *= this.friction;
            this.velocity.y *= this.friction;
            this.velocity.y += this.gravity;
            this.x += this.velocity.x;
            this.y += this.velocity.y;
            this.alpha -= 0.01;
        }
    }

    function createFirework(intensity) {
        const x = Math.random() * fwCanvas.width;
        const y = Math.random() * (fwCanvas.height * 0.5); // åœ¨ä¸ŠåŠéƒ¨çˆ†ç‚¸
        const count = 40 + (intensity * 15);
        const colors = ['#ffd700', '#ff4444', '#ffffff', '#ff69b4', '#00ff00'];
        const color = colors[Math.floor(Math.random() * colors.length)];
        
        for (let i = 0; i < count; i++) {
            const angle = (Math.PI * 2 / count) * i;
            const speed = Math.random() * 8 + 2;
            particles.push(new Particle(x, y, color, {
                x: Math.cos(angle) * speed,
                y: Math.sin(angle) * speed
            }));
        }
    }

    function animateFireworks() {
        fwCtx.clearRect(0, 0, fwCanvas.width, fwCanvas.height);
        particles.forEach((p, i) => {
            if (p.alpha <= 0) { particles.splice(i, 1); } else { p.update(); p.draw(); }
        });
        fwAnimationId = requestAnimationFrame(animateFireworks);
    }

    // --- ç¹ªåœ–å¼•æ“ ---
    function syncCanvas() {
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width * dpr; canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr); renderSlotUI();
    }

    function renderSlotUI() {
        const dpr = window.devicePixelRatio || 1;
        const w = canvas.width / dpr; const h = canvas.height / dpr;
        ctx.clearRect(0, 0, w, h);
        if (currentPrizeIdx === null) return;
        const p = lotteryConfig.prizes[currentPrizeIdx];
        const cx = w / 2; const cy = h / 2;
        ctx.fillStyle = "#c5a500"; ctx.font = `bold ${h * 0.08}px Microsoft JhengHei`; ctx.textAlign = "center";
        ctx.fillText(`${p.name}`, cx, h * 0.15);
        ctx.font = `bold ${h * 0.04}px Microsoft JhengHei`; ctx.fillText(`${p.item}`, cx, h * 0.22);
        const displayList = currentDisplayNums.length > 0 ? currentDisplayNums : (p.winners.length > 0 ? p.winners : []);
        if (displayList.length > 0) {
            const ballRadius = (p.count === 1) ? h * 0.22 : (p.count <= 5) ? h * 0.12 : h * 0.06;
            if (p.count === 1) drawLotteryBall(displayList[0], cx, cy * 1.15, ballRadius, 0);
            else if (p.count <= 5) {
                const spacing = w * 0.18; const startX = cx - (spacing * (p.count - 1)) / 2;
                displayList.forEach((num, i) => drawLotteryBall(num, startX + i * spacing, cy * 1.15, ballRadius, i));
            } else {
                const cols = 5; const rows = Math.ceil(p.count / cols);
                const gridWidth = w * 0.85; const gridHeight = h * 0.55;
                const startX = (w - gridWidth) / 2 + gridWidth / cols / 2;
                const startY = (h - gridHeight) / 2 + gridHeight / rows / 2 + h * 0.12;
                const gapX = gridWidth / cols; const gapY = gridHeight / rows;
                displayList.forEach((num, i) => { const r = Math.floor(i / cols); const c = i % cols; drawLotteryBall(num, startX + (c * gapX), startY + (r * gapY), ballRadius, i); });
            }
        } else { ctx.fillStyle = "#aaa"; ctx.font = `bold ${h * 0.12}px Microsoft JhengHei`; ctx.fillText("æº–å‚™æŠ½ç", cx, cy * 1.1); }
    }

    function drawLotteryBall(text, x, y, radius, index) {
        const scale = numberScales[index] || 1;
        const flash = flashIntensity[index] || 0;
        ctx.save(); ctx.translate(x, y); ctx.scale(scale, scale);
        ctx.shadowColor = (index < finalizedCount || !rolling) ? "rgba(255, 215, 0, 0.5)" : "rgba(0,0,0,0.2)";
        ctx.shadowBlur = (index < finalizedCount || !rolling) ? 20 * scale : 10;
        const grad = ctx.createRadialGradient(-radius/3, -radius/3, radius/5, 0, 0, radius);
        if (index < finalizedCount || !rolling) { grad.addColorStop(0, "#ff6666"); grad.addColorStop(1, "#b22222"); } else { grad.addColorStop(0, "#ffffff"); grad.addColorStop(1, "#999999"); }
        ctx.beginPath(); ctx.arc(0, 0, radius, 0, Math.PI * 2); ctx.fillStyle = grad; ctx.fill();
        if (flash > 0) { ctx.beginPath(); ctx.arc(0, 0, radius * 1.1, 0, Math.PI * 2); ctx.fillStyle = `rgba(255, 255, 255, ${flash})`; ctx.fill(); }
        ctx.fillStyle = "#fff"; ctx.font = `bold ${radius * 0.9}px Arial`; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.shadowBlur = 0; ctx.fillText(text, 0, 0);
        ctx.restore();
    }

    function triggerBounceAndFlash(index) {
        let scale = 1.0; let growing = true; let flash = 1.0;
        const anim = setInterval(() => {
            if (growing) { scale += 0.2; if (scale >= 1.6) growing = false; } else { scale -= 0.1; if (scale <= 1.0) { scale = 1.0; } }
            flash -= 0.05; if (flash <= 0) flash = 0;
            numberScales[index] = scale; flashIntensity[index] = flash; renderSlotUI();
            if (scale === 1.0 && flash === 0) clearInterval(anim);
        }, 30);
    }

    // --- æŠ½çåŸ·è¡Œ ---
    function goToDraw(idx) {
        if (!lotteryConfig.prizes[idx].unlocked) return;
        currentPrizeIdx = idx; const p = lotteryConfig.prizes[idx];
        currentDisplayNums = []; finalizedCount = 0;
        const drawBtn = document.getElementById('main-draw-btn');
        drawBtn.innerText = p.winners && p.winners.length > 0 ? "æœ¬çé …å·²é–‹ç" : "é–‹å§‹æŠ½ç";
        drawBtn.disabled = p.winners && p.winners.length > 0;
        showPage('draw-page');
    }

    function handleDrawStart() {
        if (rolling || currentPrizeIdx === null) return;
        const p = lotteryConfig.prizes[currentPrizeIdx];
        if (p.winners.length > 0) return;
        if (lotteryConfig.totalParticipants - drawnNumbers.size < p.count) { alert("åé¡ä¸è¶³ï¼"); return; }
        
        rolling = true;
        const drawBtn = document.getElementById('main-draw-btn');
        drawBtn.innerText = "é–‹çä¸­..."; drawBtn.disabled = true;
        numberScales = new Array(p.count).fill(1); flashIntensity = new Array(p.count).fill(0);
        targetResults = [];
        let tempSet = new Set(drawnNumbers);
        while (targetResults.length < p.count) {
            let n = Math.floor(Math.random() * lotteryConfig.totalParticipants) + 1;
            if (!tempSet.has(n)) { targetResults.push(n); tempSet.add(n); }
        }
        for (let i = targetResults.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1)); [targetResults[i], targetResults[j]] = [targetResults[j], targetResults[i]];
        }
        
        finalizedCount = 0; let startTime = Date.now();
        const firstDelay = 3000; const interval = 1500;
        let lastFinalizedCount = 0;
        
        timer = setInterval(() => {
            let elapsed = Date.now() - startTime;
            if (elapsed < firstDelay) finalizedCount = 0;
            else finalizedCount = 1 + Math.floor((elapsed - firstDelay) / interval);
            if (finalizedCount > p.count) finalizedCount = p.count;
            if (finalizedCount > lastFinalizedCount) { triggerBounceAndFlash(lastFinalizedCount); lastFinalizedCount = finalizedCount; }
            currentDisplayNums = [];
            for (let i = 0; i < p.count; i++) { currentDisplayNums.push(i < finalizedCount ? targetResults[i] : Math.floor(Math.random() * lotteryConfig.totalParticipants) + 1); }
            renderSlotUI();
            
            if (finalizedCount >= p.count) { 
                clearInterval(timer);
                p.winners = [...targetResults];
                saveState();
                rolling = false;
                drawBtn.innerText = "é–‹çå®Œæˆ"; drawBtn.disabled = true;
                renderPrizeList();

                // è§¸ç™¼ç…™ç«ï¼šå¾ç¬¬13çé–‹å§‹ (å°æ‡‰æ•¸å€¼ index 12 åˆ° 0)
                // åºè™Ÿ 13ç = index 12, 1ç = index 0
                if (currentPrizeIdx <= 12) {
                    const intensity = (14 - (currentPrizeIdx + 1)); // 13çå¼·åº¦1, 1çå¼·åº¦13
                    startFireworks(intensity);
                }
            }
        }, 50);
    }

    function startFireworks(intensity) {
        cancelAnimationFrame(fwAnimationId);
        animateFireworks();
        const launchCount = 3 + intensity;
        for(let i=0; i<launchCount; i++) {
            setTimeout(() => createFirework(intensity), i * 600);
        }
    }

    // --- è¨­å®šæ¸²æŸ“ ---
    function renderSettings() {
        const list = document.getElementById('settings-list');
        list.innerHTML = lotteryConfig.prizes.map((p, i) => `
            <div class="settings-row">
                <input type="text" class="row-name" value="${p.name}">
                <input type="text" class="row-content" value="${p.item}">
                <input type="text" class="row-img" value="${p.img || ''}">
                <input type="number" class="row-count" value="${p.count}">
                <button class="btn-del" onclick="this.parentElement.remove()">X</button>
            </div>
        `).join('');
        document.getElementById('total-participants').value = lotteryConfig.totalParticipants;
    }

    function addPrizeRow() {
        const list = document.getElementById('settings-list');
        const nextIdx = document.querySelectorAll('.settings-row').length + 1;
        const autoName = "çé … " + nextIdx.toString().padStart(2, '0');
        const autoImg = nextIdx.toString().padStart(2, '0') + ".jpg";
        const div = document.createElement('div');
        div.className = 'settings-row';
        div.innerHTML = `<input type="text" class="row-name" value="${autoName}"><input type="text" class="row-content" value="" placeholder="çå“åç¨±"><input type="text" class="row-img" value="${autoImg}"><input type="number" class="row-count" value="1"><button class="btn-del" onclick="this.parentElement.remove()">X</button>`;
        list.appendChild(div);
    }

    function saveSettings() {
        const rows = document.querySelectorAll('.settings-row');
        lotteryConfig.prizes = Array.from(rows).map(row => ({
            name: row.querySelector('.row-name').value,
            item: row.querySelector('.row-content').value,
            img: row.querySelector('.row-img').value,
            count: parseInt(row.querySelector('.row-count').value) || 1,
            winners: [], unlocked: false
        }));
        lotteryConfig.totalParticipants = parseInt(document.getElementById('total-participants').value) || 50;
        saveState(); showPage('home-page');
    }

    function renderPrizeList() {
        const grid = document.getElementById('main-prize-grid');
        grid.innerHTML = lotteryConfig.prizes.map((p, i) => {
            const sortedWinners = p.winners ? [...p.winners].sort((a,b)=>a-b) : [];
            const winnersHtml = sortedWinners.map(num => `<span class="winner-num">${num}</span>`).join('');
            const imgSrc = p.img || 'https://placehold.co/320x180?text=No+Image';
            return `
            <div class="card" onclick="goToDraw(${i})">
                <div id="overlay-${i}" class="prize-overlay ${p.unlocked ? 'unlocked' : ''}">
                    <div style="font-size: 50px; margin-bottom: 20px;">ğŸ§§</div>
                    <button class="unlock-btn" onclick="unlockPrize(${i}, event)">é–‹å•Ÿçé …</button>
                </div>
                <div class="card-img-wrapper"><img class="card-img" src="${imgSrc}" onerror="this.src='https://placehold.co/320x180?text=ç…§ç‰‡ç¼ºå¤±'"></div>
                <div style="font-size:2.6vh; color:var(--gold); font-weight:bold;">${p.name}</div>
                <div style="font-size:1.8vh; margin:8px 0; min-height:2.4em; overflow:hidden; color:#fff;">${p.item}</div>
                <div style="font-size:1.4vh; opacity:0.8;">åé¡ï¼š${p.count}</div>
                ${sortedWinners.length > 0 ? `<div class="winner-tag-container"><div class="winner-label">å¾—çè™Ÿç¢¼</div><div class="winner-list">${winnersHtml}</div></div>` : ''}
            </div>`;
        }).join('');
    }

    document.addEventListener('mousedown', (e) => {
        const halo = document.createElement('div');
        halo.className = 'click-halo'; halo.style.left = e.clientX + 'px'; halo.style.top = e.clientY + 'px';
        document.body.appendChild(halo); setTimeout(() => halo.remove(), 600);
    });

    window.onload = initSystem;
</script>
</body>
</html>
