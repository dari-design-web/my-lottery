<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§æ—¥é–‹ç™¼æœ‰é™å…¬å¸ 2025 å¹´çµ‚æŠ½ç</title>
    <style>
        :root { 
            --gold-light: #fff5bc;
            --gold: #e2c070; 
            --gold-dark: #a67c00;
            --red-packet: #c0392b;
            --red-packet-dark: #922b21;
            --light-gray: #f8f9fa;
        }
        
        * { box-sizing: border-box; }
        
        html, body, a, button, .card, canvas { cursor: pointer !important; }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: #000; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; 
            color: white; overflow: hidden; 
        }

        /* é»æ“Šå…‰æšˆ */
        .click-halo {
            position: fixed; width: 10px; height: 10px;
            background: rgba(226, 192, 112, 0.4); border: 1px solid var(--gold);
            border-radius: 50%; pointer-events: none; z-index: 100000;
            transform: translate(-50%, -50%);
            animation: halo-effect 0.6s ease-out forwards;
        }
        @keyframes halo-effect {
            0% { width: 10px; height: 10px; opacity: 1; }
            100% { width: 100px; height: 100px; opacity: 0; }
        }

        .page { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            display: none; z-index: 1;
            background: url('bg1.jpg') no-repeat center center;
            background-size: cover;
        }

        .glass-overlay {
            position: absolute; inset: 0;
            background: rgba(0,0,0,0.72);
            display: flex; flex-direction: column; align-items: center; padding-top: 5vh;
            overflow-y: auto; padding-bottom: 220px; 
        }

        /* --- ä¸»æ¨™é¡Œè¨­è¨ˆ --- */
        .header-container { text-align: center; margin-bottom: 5vh; }
        .company-title {
            font-size: 2.2vh; font-weight: 200; letter-spacing: 1.5rem;
            color: var(--gold-light); margin-bottom: 12px; text-indent: 1.5rem;
        }
        .main-event-title {
            font-size: 7.5vh; font-weight: 800;
            background: linear-gradient(to bottom, #f9dfa5 0%, #e2c070 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            letter-spacing: 1rem; text-indent: 1rem;
            filter: drop-shadow(0 3px 6px rgba(0,0,0,0.5));
        }

        /* é¸å–®æŒ‰éˆ• */
        .home-menu { display: flex; gap: 40px; margin-top: 8vh; }
        .menu-btn {
            padding: 20px 70px; font-size: 3vh; font-weight: bold;
            background: rgba(139, 0, 0, 0.3); border: 1.5px solid var(--gold); border-radius: 8px;
            color: var(--gold); transition: 0.4s; letter-spacing: 5px; text-indent: 5px;
            backdrop-filter: blur(10px);
        }
        .menu-btn:hover { background: var(--gold); color: #000; box-shadow: 0 0 30px var(--gold); transform: translateY(-5px); }

        /* çé …é¸æ“‡å¡ç‰‡ */
        .prize-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 30px; width: 92%; max-width: 1600px; }
        .card { 
            position: relative; background: #121212; border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 16px; padding: 20px; text-align: center;
            transition: 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex; flex-direction: column; align-items: center;
            min-height: 460px; overflow: hidden;
        }
        .card:hover { transform: translateY(-10px); border-color: var(--gold); background: #1a1a1a; }
        
        /* ç´…åŒ…è¢‹å„ªåŒ– */
        .prize-overlay {
            position: absolute; inset: 0;
            background: linear-gradient(135deg, #b03a2e 0%, #78281f 100%);
            z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 1.5s cubic-bezier(0.19, 1, 0.22, 1), visibility 1.5s;
        }
        .prize-overlay.unlocked { opacity: 0; pointer-events: none; visibility: hidden; }
        
        .red-packet-rank-tag {
            background: rgba(0,0,0,0.25); border: 1px solid var(--gold);
            padding: 6px 25px; border-radius: 4px; color: var(--gold-light);
            font-size: 2.4vh; font-weight: bold; margin-bottom: 25px; letter-spacing: 4px;
        }
        .red-packet-icon { font-size: 50px; margin-bottom: 30px; opacity: 0.9; }

        .unlock-btn {
            background: linear-gradient(145deg, #f9dfa5, #e2c070);
            color: #500; border: none; padding: 12px 40px; font-size: 18px; font-weight: 800; border-radius: 50px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4); transition: 0.3s;
        }
        .unlock-btn:hover { transform: scale(1.1); background: #fff; box-shadow: 0 0 20px var(--gold); }

        /* åœ–ç‰‡å±•ç¾ */
        .card-img-wrapper {
            width: 100%; height: 180px; border-radius: 8px; background: var(--light-gray); 
            overflow: hidden; margin-bottom: 15px; display: flex; align-items: center; justify-content: center;
        }
        .card-img { 
            width: 100%; height: 100%; object-fit: contain; transform: scale(2.2);
            transition: transform 1.5s cubic-bezier(0.19, 1, 0.22, 1); 
        }
        .card:hover .card-img { transform: scale(1.0); } 
        
        .prize-title-text { font-size: 2.2vh; color: var(--gold); font-weight: 900; margin-bottom: 8px; }
        .prize-item-text { font-size: 1.6vh; color: #ccc; margin-bottom: 12px; height: 2.8em; line-height: 1.4; overflow: hidden; }
        .prize-count-text { font-size: 1.3vh; color: #888; font-weight: 300; }

        /* ä¸­çæ¨™ç±¤ - ç´…è‰²åœ“çƒåå–® */
        .winner-tag-container { margin-top: auto; width: 100%; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.05); }
        .winner-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; }
        .winner-num { 
            width: 32px; height: 32px; 
            background: radial-gradient(circle at 30% 30%, #ff4d4d, #b22222);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.4vh; font-weight: 900; box-shadow: 0 3px 6px rgba(0,0,0,0.5);
        }

        /* æŠ½çä¸»æ¡† (ä¿®æ­£ç½®ä¸­) */
        .display-frame {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            width: 85vw; height: 62vh; background: #fff;
            border: 12px solid var(--gold); border-radius: 24px;
            box-shadow: 0 40px 100px rgba(0,0,0,0.8);
            overflow: hidden; display: flex; z-index: 10;
        }
        .draw-left-img-box { flex: 1; border-right: 1px solid #ddd; background: var(--light-gray); display: flex; align-items: center; justify-content: center; padding: 40px; }
        .draw-right-nums-box { flex: 1.6; position: relative; display: flex; align-items: center; justify-content: center; background: #fff; }
        
        .prize-main-img { max-width: 90%; max-height: 90%; object-fit: contain; animation: prize-reveal 1.5s cubic-bezier(0.19, 1, 0.22, 1) forwards; }
        @keyframes prize-reveal { from { transform: scale(1.8); } to { transform: scale(1.0); } }

        /* åº•éƒ¨æŒ‰éˆ•åˆ— */
        .bottom-actions {
            position: fixed; bottom: 0; left: 0; width: 100%;
            padding: 35px 0; display: flex; gap: 30px; justify-content: center;
            z-index: 2000; background: rgba(0,0,0,0.92);
            backdrop-filter: blur(20px); border-top: 1px solid rgba(226, 192, 112, 0.4);
        }
        .action-btn { 
            padding: 15px 50px; border-radius: 6px; border: 1px solid var(--gold); 
            background: transparent; color: var(--gold); font-weight: bold; font-size: 18px;
            transition: 0.3s; letter-spacing: 4px;
        }
        .action-btn:hover { background: var(--gold); color: #000; transform: translateY(-3px); }
        .action-btn.danger { border-color: #800; color: #e74c3c; }

        #slot-canvas { width: 100%; height: 100%; position: relative; z-index: 20; }
        #fw-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 30; }

        /* è¨­å®šä»‹é¢ */
        .settings-container { width: 95%; max-width: 1300px; background: #111; padding: 40px; border-radius: 12px; border: 1px solid #333; margin-bottom: 50px; }
        .settings-row { display: flex; gap: 10px; margin-bottom: 12px; }
        .settings-row input { padding: 12px; background: #fff; color: #000; border: none; border-radius: 4px; font-weight: bold; font-size: 16px; }

        /* è‡ªå®šç¾©è¨Šæ¯æ¡† */
        #msg-box {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95); border: 2px solid var(--gold); padding: 30px 60px;
            border-radius: 12px; z-index: 5000; display: none; text-align: center;
            box-shadow: 0 0 100px rgba(0,0,0,1);
        }
        #msg-box p { font-size: 24px; color: #fff; margin-bottom: 25px; font-weight: bold; }
        #msg-box button { padding: 10px 30px; background: var(--gold); border: none; font-weight: bold; border-radius: 4px; }
    </style>
</head>
<body>

<canvas id="fw-canvas"></canvas>

<div id="msg-box">
    <p id="msg-text"></p>
    <button onclick="closeMsg()">ç¢ºå®š</button>
</div>

<!-- é¦–é  -->
<div id="home-page" class="page" style="display: block;">
    <div class="glass-overlay">
        <div class="header-container">
            <div class="company-title">å¤§æ—¥é–‹ç™¼æœ‰é™å…¬å¸</div>
            <div class="main-event-title">å¹´çµ‚æŠ½ç</div>
        </div>
        <div class="home-menu">
            <button class="menu-btn" onclick="showPage('settings-page')">çé …è¨­å®š</button>
            <button class="menu-btn" onclick="showPage('prize-list-page')">é–‹å§‹æŠ½ç</button>
        </div>
    </div>
</div>

<!-- è¨­å®š -->
<div id="settings-page" class="page">
    <div class="glass-overlay">
        <div class="header-container">
            <div class="company-title">å¤§æ—¥é–‹ç™¼æœ‰é™å…¬å¸</div>
            <div class="main-event-title" style="font-size: 4vh;">çé …åƒæ•¸è¨­å®š</div>
        </div>
        <div class="settings-container">
            <div style="margin-bottom: 30px; font-size: 24px; font-weight: bold; color: var(--gold);">
                ğŸ‘¥ ç›®å‰æŠ½çç¸½äººæ•¸ï¼š
                <input type="number" id="total-participants" style="width: 100px; text-align: center;" value="37"> äºº
            </div>
            <div id="settings-list"></div>
            <button class="btn-add" style="background:#27ae60; color:white; padding:12px 25px; border-radius:8px; border:none; font-weight:bold; margin-bottom:20px;" onclick="addPrizeRow()">ï¼‹ æ–°å¢æ›´å¤šçé …</button>
            <div class="settings-actions">
                <button class="action-btn" onclick="saveSettings()">å„²å­˜è¨­å®šä¸¦è¿”å›</button>
            </div>
        </div>
    </div>
</div>

<!-- æ­æ›‰ -->
<div id="prize-list-page" class="page">
    <div class="glass-overlay">
        <div class="header-container">
            <div class="company-title">å¤§æ—¥é–‹ç™¼æœ‰é™å…¬å¸</div>
            <div class="main-event-title" style="font-size: 4.5vh;">æ­æ›‰çé …</div>
        </div>
        <div class="prize-grid" id="main-prize-grid"></div>
        <div class="bottom-actions">
            <button class="action-btn danger" onclick="resetAllWinners()">ğŸ”„ é‡ç½®ç´€éŒ„</button>
            <button class="action-btn" onclick="exportWinnersToCSV()">ğŸ“Š åŒ¯å‡º Excel</button>
            <button class="action-btn" style="border-color:#fff; color:#fff;" onclick="showPage('home-page')">è¿”å›é¦–é </button>
        </div>
    </div>
</div>

<!-- æŠ½çåŸ·è¡Œ -->
<div id="draw-page" class="page">
    <div class="display-frame">
        <div class="draw-left-img-box">
            <img id="prize-main-img" src="" class="prize-main-img" onerror="this.src='https://placehold.co/600x600?text=ç…§ç‰‡æª”æ¡ˆç¼ºå¤±'">
        </div>
        <div class="draw-right-nums-box">
            <canvas id="slot-canvas"></canvas>
        </div>
    </div>
    <div style="position: absolute; bottom: 10vh; left: 50%; transform: translateX(-50%); z-index: 100;">
        <button id="main-draw-btn" style="padding: 20px 120px; font-size: 4.5vh; font-weight: 900; color: #000; background: linear-gradient(180deg, #f9dfa5, #e2c070); border: none; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); letter-spacing: 12px; cursor:pointer;" onclick="handleDrawStart()">é–‹å§‹æŠ½ç</button>
    </div>
    <button class="action-btn" style="position: fixed; bottom: 3vh; right: 3vh; z-index: 2001; font-size: 14px; padding: 10px 30px; opacity: 0.6;" onclick="showPage('prize-list-page')">è¿”å›åˆ—è¡¨</button>
</div>

<script>
    const STORAGE_KEY = 'daini_lottery_v42_final_logic_fix';

    // çé …æ¸…å–®ç²¾æº–è¼‰å…¥
    const INITIAL_DATA = {
        totalParticipants: 37,
        prizes: [
            { name: "1 ç", item: "Xiaomi æ™ºæ…§é¡¯ç¤ºå™¨ A Pro 2026 75å‹ QLED", count: 1, winners: [], img: "01.jpg", unlocked: false },
            { name: "2 ç", item: "Xiaomi æƒæ‹–æ©Ÿå™¨äºº 5 Pro", count: 1, winners: [], img: "02.jpg", unlocked: false },
            { name: "3 ç", item: "SWITCH 2 ä¸»æ©Ÿ", count: 1, winners: [], img: "03.jpg", unlocked: false },
            { name: "4 ç", item: "Apple å¹³æ¿ iPad 11 A16 Wi-Fi (128G)", count: 1, winners: [], img: "04.jpg", unlocked: false },
            { name: "5 ç", item: "Apple Watch SE 3ä»£ (44mm) GPSç‰ˆ", count: 1, winners: [], img: "05.jpg", unlocked: false },
            { name: "6 ç", item: "åœ‹éš›ç‰Œ é«˜æ»²é€å¥ˆç±³æ°´é›¢å­å¹é¢¨æ©ŸEH-NA0J-A", count: 1, winners: [], img: "06.jpg", unlocked: false },
            { name: "7 ç", item: "SWITCH 1 ä¸»æ©Ÿ (ç¾æœ‰)", count: 2, winners: [], img: "07.jpg", unlocked: false },
            { name: "8 ç", item: "AirPods Pro 3 é¦¬å¹´ç‰¹åˆ¥æ¬¾", count: 1, winners: [], img: "08.jpg", unlocked: false },
            { name: "9 ç", item: "LG é›»å­ PuriCare 360åº¦ç©ºæ°£æ¸…æ·¨æ©Ÿ", count: 1, winners: [], img: "09.jpg", unlocked: false },
            { name: "10 ç", item: "SHARP å¤æ™® 8.5å…¬å‡ è‡ªå‹•é™¤èŒé›¢å­é™¤æ¿•æ©Ÿ", count: 1, winners: [], img: "10.jpg", unlocked: false },
            { name: "11 ç", item: "PHILIPS é£›åˆ©æµ¦æ˜Ÿè¦–ç•Œé€è¦–æµ·æ˜Ÿæ°£ç‚¸é‹4.2L", count: 1, winners: [], img: "11.jpg", unlocked: false },
            { name: "12 ç", item: "Apple è—ç‰™è€³æ©Ÿ AirPods 4ä»£ (ä¸»å‹•é™å™ªæ¬¾)", count: 1, winners: [], img: "12.jpg", unlocked: false },
            { name: "13 ç", item: "æ–°å…‰ä¸‰è¶Šç¦®åˆ¸ 5000 å…ƒ", count: 1, winners: [], img: "13.jpg", unlocked: false },
            { name: "14 ç", item: "OSIM è­·çœ¼æ¨‚ Air 2", count: 2, winners: [], img: "14.jpg", unlocked: false },
            { name: "15 ç", item: "æ–°å…‰ä¸‰è¶Šç¦®åˆ¸ 3000 å…ƒ", count: 1, winners: [], img: "15.jpg", unlocked: false },
            { name: "16 ç", item: "æ—¥æœ¬ BRUNO å¤šåŠŸèƒ½é›»çƒ¤ç›¤ BOE021", count: 2, winners: [], img: "16.jpg", unlocked: false },
            { name: "17 ç", item: "æ–°å…‰ä¸‰è¶Šç¦®åˆ¸ 1000 å…ƒ", count: 18, winners: [], img: "17.jpg", unlocked: false }
        ]
    };

    let lotteryConfig = { ...INITIAL_DATA };
    let drawnNumbers = new Set();
    let currentPrizeIdx = null;
    let rolling = false;
    let timer = null;
    let currentDisplayNums = [];
    let finalizedCount = 0;
    let targetResults = [];
    let numberScales = [];
    let flashIntensity = [];
    let hasAnimated = []; // å‹•æ…‹é–å®š
    const canvas = document.getElementById('slot-canvas');
    const ctx = canvas.getContext('2d');

    const fwCanvas = document.getElementById('fw-canvas');
    const fwCtx = fwCanvas.getContext('2d');
    let particles = [];
    let fwAnimationId = null;

    function initSystem() {
        const localData = localStorage.getItem(STORAGE_KEY);
        if (localData) { lotteryConfig = JSON.parse(localData); } else { saveState(); }
        updateDrawnSet(); renderPrizeList(); renderSettings();
        window.addEventListener('resize', resizeFwCanvas); resizeFwCanvas();
    }

    function updateDrawnSet() {
        drawnNumbers.clear();
        lotteryConfig.prizes.forEach(p => { if(p.winners) p.winners.forEach(w => drawnNumbers.add(w)); });
    }

    function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(lotteryConfig)); updateDrawnSet(); }

    function showMsg(text) {
        document.getElementById('msg-text').innerText = text;
        document.getElementById('msg-box').style.display = 'block';
    }
    function closeMsg() { document.getElementById('msg-box').style.display = 'none'; }

    function unlockPrize(idx, event) {
        event.stopPropagation();
        document.getElementById(`overlay-${idx}`).classList.add('unlocked');
        lotteryConfig.prizes[idx].unlocked = true;
        saveState();
    }

    function resetAllWinners() {
        if (confirm("âš ï¸ æ³¨æ„ï¼šé€™å°‡é‡ç½®æ‰€æœ‰ç´€éŒ„ä¸¦é‡æ–°é–å®šç´…åŒ…ï¼ç¢ºå®šå—ï¼Ÿ")) {
            lotteryConfig.prizes.forEach(p => { p.winners = []; p.unlocked = false; });
            drawnNumbers.clear(); particles = []; saveState(); renderPrizeList();
        }
    }

    function exportWinnersToCSV() {
        let csvContent = "\uFEFF"; let maxCount = 0;
        lotteryConfig.prizes.forEach(p => { if(p.count > maxCount) maxCount = p.count; });
        let header = ["çé …", "å…§å®¹", "åé¡"];
        for(let i=1; i<=maxCount; i++) header.push(`å¾—çè™Ÿç¢¼${i}`);
        csvContent += header.join(",") + "\n";
        lotteryConfig.prizes.forEach(p => {
            let row = [p.name, p.item, p.count];
            const sorted = p.winners ? [...p.winners].sort((a,b)=>a-b) : [];
            for(let i=0; i<maxCount; i++) row.push(sorted[i] || ""); 
            csvContent += row.join(",") + "\n";
        });
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url); link.setAttribute("download", `å¤§æ—¥é–‹ç™¼æŠ½çåå–®.csv`); link.click();
    }

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        if (id === 'draw-page') {
            particles = []; 
            const imgEl = document.getElementById('prize-main-img');
            imgEl.src = lotteryConfig.prizes[currentPrizeIdx].img || '';
            imgEl.style.animation = 'none'; imgEl.offsetHeight; imgEl.style.animation = null;
            
            // é‡ç½® Canvas ç¹ªåœ–ç‹€æ…‹
            finalizedCount = 0;
            currentDisplayNums = [];
            rolling = false;
            const drawBtn = document.getElementById('main-draw-btn');
            drawBtn.innerText = lotteryConfig.prizes[currentPrizeIdx].winners.length > 0 ? "é–‹çå®Œæˆ" : "é–‹å§‹æŠ½ç";
            drawBtn.disabled = lotteryConfig.prizes[currentPrizeIdx].winners.length > 0;
            
            setTimeout(syncCanvas, 100);
        }
        if (id === 'prize-list-page') { cancelAnimationFrame(fwAnimationId); renderPrizeList(); }
        if (id === 'settings-page') renderSettings();
    }

    // --- ç…™ç«ç‰¹æ•ˆ ---
    function resizeFwCanvas() { fwCanvas.width = window.innerWidth; fwCanvas.height = window.innerHeight; }
    class Particle {
        constructor(x, y, color, velocity) {
            this.x = x; this.y = y; this.color = color; this.velocity = velocity;
            this.alpha = 1; this.friction = 0.96; this.gravity = 0.16;
        }
        draw() { fwCtx.save(); fwCtx.globalAlpha = this.alpha; fwCtx.beginPath(); fwCtx.arc(this.x, this.y, 2.5, 0, Math.PI * 2); fwCtx.fillStyle = this.color; fwCtx.fill(); fwCtx.restore(); }
        update() { this.velocity.x *= this.friction; this.velocity.y *= this.friction; this.velocity.y += this.gravity; this.x += this.velocity.x; this.y += this.velocity.y; this.alpha -= 0.012; }
    }
    function createFirework(intensity) {
        const x = Math.random() * fwCanvas.width; const y = Math.random() * (fwCanvas.height * 0.5);
        const count = 50 + (intensity * 12); const colors = ['#e2c070', '#ff4d4d', '#ffffff', '#00e5ff', '#ffa726'];
        const color = colors[Math.floor(Math.random() * colors.length)];
        for (let i = 0; i < count; i++) {
            const angle = (Math.PI * 2 / count) * i; const speed = Math.random() * 10 + 4;
            particles.push(new Particle(x, y, color, { x: Math.cos(angle) * speed, y: Math.sin(angle) * speed }));
        }
    }
    function animateFireworks() {
        fwCtx.clearRect(0, 0, fwCanvas.width, fwCanvas.height);
        particles.forEach((p, i) => { if (p.alpha <= 0) { particles.splice(i, 1); } else { p.update(); p.draw(); } });
        fwAnimationId = requestAnimationFrame(animateFireworks);
    }

    // --- å½©çƒæ¸²æŸ“ ---
    function syncCanvas() {
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width * dpr; canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr); renderSlotUI();
    }
    function renderSlotUI() {
        const dpr = window.devicePixelRatio || 1; const w = canvas.width / dpr; const h = canvas.height / dpr;
        ctx.clearRect(0, 0, w, h); if (currentPrizeIdx === null) return;
        const p = lotteryConfig.prizes[currentPrizeIdx]; const cx = w / 2; const cy = h / 2;
        ctx.fillStyle = "#c5a500"; ctx.font = `900 ${h * 0.08}px Microsoft JhengHei`; ctx.textAlign = "center";
        ctx.fillText(`${p.name}`, cx, h * 0.15);
        ctx.font = `300 ${h * 0.035}px Microsoft JhengHei`; ctx.fillText(`${p.item}`, cx, h * 0.22);
        
        const displayList = currentDisplayNums.length > 0 ? currentDisplayNums : (p.winners.length > 0 ? p.winners : []);
        if (displayList.length > 0) {
            const ballRadius = (p.count === 1) ? h * 0.22 : (p.count <= 5) ? h * 0.13 : h * 0.065;
            if (p.count === 1) {
                drawLotteryBall(displayList[0], cx, cy * 1.15, ballRadius, 0);
            } else if (p.count <= 5) {
                // åŠ å¤§é–“è·ç¢ºä¿ 2-5 ä½ä¸é‡ç–Š (ä½¿ç”¨ 0.38w)
                const spacing = w * 0.38; const startX = cx - (spacing * (p.count - 1)) / 2;
                displayList.forEach((num, i) => drawLotteryBall(num, startX + i * spacing, cy * 1.15, ballRadius, i));
            } else {
                const cols = 6; const rows = Math.ceil(p.count / cols);
                const gridWidth = w * 0.9; const gridHeight = h * 0.55;
                const startX = (w - gridWidth) / 2 + gridWidth / cols / 2;
                const startY = (h - gridHeight) / 2 + gridHeight / rows / 2 + h * 0.12;
                const gapX = gridWidth / cols; const gapY = gridHeight / rows;
                displayList.forEach((num, i) => { const r = Math.floor(i / cols); const c = i % cols; drawLotteryBall(num, startX + (c * gapX), startY + (r * gapY), ballRadius, i); });
            }
        } else { ctx.fillStyle = "#ccc"; ctx.font = `100 ${h * 0.12}px Microsoft JhengHei`; ctx.fillText("READY", cx, cy * 1.1); }
    }
    function drawLotteryBall(text, x, y, radius, index) {
        const scale = numberScales[index] || 1; const flash = flashIntensity[index] || 0;
        ctx.save(); ctx.translate(x, y); ctx.scale(scale, scale);
        ctx.shadowColor = (index < finalizedCount || !rolling) ? "rgba(226, 192, 112, 0.7)" : "rgba(0,0,0,0.1)";
        ctx.shadowBlur = (index < finalizedCount || !rolling) ? 25 * scale : 10;
        const grad = ctx.createRadialGradient(-radius/3, -radius/3, radius/5, 0, 0, radius);
        if (index < finalizedCount || !rolling) { grad.addColorStop(0, "#ff8888"); grad.addColorStop(1, "#800"); } else { grad.addColorStop(0, "#ffffff"); grad.addColorStop(1, "#aaa"); }
        ctx.beginPath(); ctx.arc(0, 0, radius, 0, Math.PI * 2); ctx.fillStyle = grad; ctx.fill();
        if (flash > 0) { ctx.beginPath(); ctx.arc(0, 0, radius * 1.35, 0, Math.PI * 2); ctx.fillStyle = `rgba(255, 255, 255, ${flash})`; ctx.fill(); }
        ctx.fillStyle = "#fff"; ctx.font = `bold ${radius * 0.95}px Arial`; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText(text, 0, 0); ctx.restore();
    }
    
    // ç¢ºåˆ‡åªå½ˆè·³ä¸€æ¬¡ï¼Œ1ç§’å…§çµæŸ
    function triggerBounceAndFlash(index) {
        if (hasAnimated[index]) return;
        hasAnimated[index] = true;
        let step = 0; let scale = 1.0; let flash = 1.0;
        const anim = setInterval(() => {
            if (step === 0) {
                scale += 0.22; if (scale >= 1.65) step = 1;
            } else if (step === 1) {
                scale -= 0.18; if (scale <= 1.0) { scale = 1.0; step = 2; }
            } else {
                flash -= 0.12; if (flash <= 0) { flash = 0; clearInterval(anim); }
            }
            numberScales[index] = scale; flashIntensity[index] = flash; renderSlotUI();
        }, 35);
    }

    // --- æŠ½çå¼•æ“ (é‚„åŸ V3.1 ç©©å®šç‰ˆ) ---
    function handleDrawStart() {
        if (rolling || currentPrizeIdx === null) return;
        const p = lotteryConfig.prizes[currentPrizeIdx];
        if (p.winners.length > 0) return;
        if (lotteryConfig.totalParticipants - drawnNumbers.size < p.count) { showMsg("å‰©é¤˜äººæ•¸ä¸è¶³æŠ½å–æ­¤çé …ï¼"); return; }
        
        rolling = true;
        const drawBtn = document.getElementById('main-draw-btn');
        drawBtn.innerText = "æ­£åœ¨æŠ½ç..."; drawBtn.disabled = true;
        
        numberScales = new Array(p.count).fill(1);
        flashIntensity = new Array(p.count).fill(0);
        hasAnimated = new Array(p.count).fill(false);
        finalizedCount = 0;
        currentDisplayNums = new Array(p.count).fill(-1);

        // ç”Ÿæˆçµæœåå–® (å¾éé‡è¤‡æ± ä¸­éš¨æ©ŸæŒ‘é¸)
        targetResults = []; 
        let tempSet = new Set(drawnNumbers);
        while (targetResults.length < p.count) {
            let n = Math.floor(Math.random() * lotteryConfig.totalParticipants) + 1;
            if (!tempSet.has(n)) { targetResults.push(n); tempSet.add(n); }
        }
        // æ´—ç‰Œå¢åŠ éš¨æ©Ÿæ„Ÿ
        for (let i = targetResults.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [targetResults[i], targetResults[j]] = [targetResults[j], targetResults[i]]; }
        
        let startTime = Date.now();
        const INITIAL_WAIT = 2500; 
        const INTERVAL_PER_BALL = 1200; 

        timer = setInterval(() => {
            let elapsed = Date.now() - startTime;
            
            // è¨ˆç®—ç›®å‰é–å®šäº†ç¬¬å¹¾å€‹çƒ
            let newFinalizedCount = 0;
            if (elapsed > INITIAL_WAIT) {
                newFinalizedCount = 1 + Math.floor((elapsed - INITIAL_WAIT) / INTERVAL_PER_BALL);
            }
            if (newFinalizedCount > p.count) newFinalizedCount = p.count;

            // è§¸ç™¼æ–°é–å®šçƒçš„å‹•ç•«
            if (newFinalizedCount > finalizedCount) {
                finalizedCount = newFinalizedCount;
                triggerBounceAndFlash(finalizedCount - 1);
            }

            // æ›´æ–°é¡¯ç¤ºä¸­çš„è™Ÿç¢¼
            for (let i = 0; i < p.count; i++) {
                if (i < finalizedCount) {
                    currentDisplayNums[i] = targetResults[i];
                } else {
                    currentDisplayNums[i] = Math.floor(Math.random() * lotteryConfig.totalParticipants) + 1;
                }
            }
            renderSlotUI();

            if (finalizedCount >= p.count) { 
                clearInterval(timer);
                p.winners = [...targetResults];
                saveState();
                rolling = false;
                drawBtn.innerText = "é–‹çå®Œæˆ";
                renderPrizeList();
                if (currentPrizeIdx <= 12) { startFireworks(15 - currentPrizeIdx); }
            }
        }, 50);
    }

    function startFireworks(intensity) { cancelAnimationFrame(fwAnimationId); animateFireworks(); for(let i=0; i<3 + (intensity/2); i++) { setTimeout(() => createFirework(intensity), i * 600); } }

    function renderSettings() {
        const list = document.getElementById('settings-list');
        list.innerHTML = lotteryConfig.prizes.map((p, i) => `<div class="settings-row"><input type="text" class="row-name" value="${p.name}"><input type="text" class="row-content" value="${p.item}"><input type="text" class="row-img" value="${p.img || ''}"><input type="number" class="row-count" value="${p.count}"><button style="background:#800;color:#fff;border:none;padding:10px;border-radius:4px;" onclick="this.parentElement.remove()">X</button></div>`).join('');
        document.getElementById('total-participants').value = lotteryConfig.totalParticipants;
    }
    function addPrizeRow() {
        const list = document.getElementById('settings-list');
        const nextIdx = document.querySelectorAll('.settings-row').length + 1;
        const div = document.createElement('div'); div.className = 'settings-row';
        div.innerHTML = `<input type="text" class="row-name" value="${nextIdx} ç"><input type="text" class="row-content" value=""><input type="text" class="row-img" value="${nextIdx.toString().padStart(2, '0')}.jpg"><input type="number" class="row-count" value="1"><button onclick="this.parentElement.remove()">X</button>`;
        list.appendChild(div);
    }
    function saveSettings() {
        const rows = document.querySelectorAll('.settings-row');
        lotteryConfig.prizes = Array.from(rows).map(row => ({ name: row.querySelector('.row-name').value, item: row.querySelector('.row-content').value, img: row.querySelector('.row-img').value, count: parseInt(row.querySelector('.row-count').value) || 1, winners: [], unlocked: false }));
        lotteryConfig.totalParticipants = parseInt(document.getElementById('total-participants').value) || 37;
        saveState(); showPage('home-page');
    }
    function renderPrizeList() {
        const grid = document.getElementById('main-prize-grid');
        grid.innerHTML = lotteryConfig.prizes.map((p, i) => {
            const sortedWinners = p.winners ? [...p.winners].sort((a,b)=>a-b) : [];
            const winnersHtml = sortedWinners.map(num => `<span class="winner-num">${num}</span>`).join('');
            const imgSrc = p.img || 'https://placehold.co/320x180?text=No+Image';
            return `
            <div class="card" onclick="goToDraw(${i})">
                <div id="overlay-${i}" class="prize-overlay ${p.unlocked ? 'unlocked' : ''}">
                    <div class="red-packet-rank-tag">${p.name}</div>
                    <div class="red-packet-icon">ğŸ§§</div>
                    <button class="unlock-btn" onclick="unlockPrize(${i}, event)">é–‹å•Ÿçé …</button>
                </div>
                <div class="card-img-wrapper"><img class="card-img" src="${imgSrc}" onerror="this.src='https://placehold.co/320x180?text=ç…§ç‰‡ç¼ºå¤±'"></div>
                <div class="prize-title-text">${p.name}</div>
                <div class="prize-item-text">${p.item}</div>
                <div class="prize-count-text">åé¡ï¼š${p.count}</div>
                ${sortedWinners.length > 0 ? `<div class="winner-tag-container"><div class="winner-list">${winnersHtml}</div></div>` : ''}
            </div>`;
        }).join('');
    }

    function goToDraw(idx) {
        if (!lotteryConfig.prizes[idx].unlocked) return;
        currentPrizeIdx = idx; showPage('draw-page');
    }

    document.addEventListener('mousedown', (e) => {
        const halo = document.createElement('div'); halo.className = 'click-halo'; halo.style.left = e.clientX + 'px'; halo.style.top = e.clientY + 'px';
        document.body.appendChild(halo); setTimeout(() => halo.remove(), 600);
    });

    window.onload = initSystem;
</script>
</body>
</html>
